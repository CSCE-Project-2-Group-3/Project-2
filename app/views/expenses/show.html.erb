<%# 1. Page Header: Title & Back Link %>
<div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-6">
  <h1 class="text-3xl font-bold truncate" style="color: var(--tamu-maroon);">
    <%= @expense.title %>
  </h1>
  <%= link_to "← Back to Expenses", expenses_path, class: "text-sm font-medium whitespace-nowrap",
              style: "color: var(--tamu-maroon);",
              onmouseover: "this.style.color='#a17b3e'",
              onmouseout: "this.style.color='var(--tamu-maroon)'" %>
</div>

<%# 2. Main Expense Details Card %>
<div class="bg-white rounded-lg shadow-md overflow-hidden">
  
  <%# --- Card Body: Key Details --- %>
  <div class="p-6">
    <h2 class="text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</h2>
    <p class="text-5xl font-extrabold" style="color: var(--tamu-gray-800);">
      <%= number_to_currency(@expense.amount) %>
    </p>

    <dl class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mt-6">
      <div>
        <dt class="text-xs font-medium text-gray-500 uppercase tracking-wider">Spent On</dt>
        <dd class="text-lg text-gray-900"><%= @expense.spent_on.strftime("%B %d, %Y") %></dd>
      </div>
      <div>
        <dt class="text-xs font-medium text-gray-500 uppercase tracking-wider">Category</dt>
        <dd class="text-lg text-gray-900"><%= @expense.category&.name || "—" %></dd>
      </div>
      <div class="md:col-span-2">
        <dt class="text-xs font-medium text-gray-500 uppercase tracking-wider">Split With</dt>
        <dd class="text-lg text-gray-900"><%= participant_summary(@expense) %></dd>
      </div>
      <% if @expense.notes.present? %>
        <div class="md:col-span-2">
          <dt class="text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</dt>
          <dd class="mt-1 text-gray-700 prose prose-sm"><%= simple_format(@expense.notes) %></dd>
        </div>
      <% end %>
    </dl>
  </div>
  
  <%# --- Card Footer: Send Message Action --- %>
  <div class="p-6 border-t border-gray-200" style="background-color: var(--tamu-gray-100);">
    <% if user_signed_in? && current_user.id != @expense.user_id %>
      <%= button_to "Send Message to Author", conversations_path(recipient_id: @expense.user_id, expense_author_id: @expense.user_id), method: :post, class: "btn-maroon py-2 px-4 rounded-lg font-semibold cursor-pointer" %>
    <% elsif user_signed_in? %>
      <p class="text-sm text-gray-500 italic">This is your expense.</p>
    <% else %>
      <%= link_to "Log in to message the author", new_user_session_path, class: "font-medium hover:underline", style: "color: var(--tamu-maroon);" %>
    <% end %>
  </div>
</div>

<%# 3. Actions Card (Edit/Delete) - Only for owner %>
<% if @expense.user == current_user %>
  <div class="mt-6 p-6 bg-white shadow-lg rounded-lg border border-gray-200">
    <h3 class="text-lg font-medium text-gray-800">Manage Expense</h3>
    <div class="flex flex-col sm:flex-row gap-4 mt-4">
      <%= link_to "Edit this expense", edit_expense_path(@expense), class: "inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white transition duration-150 ease-in-out cursor-pointer", style: "background-color: var(--tamu-accent);", onmouseover: "this.style.backgroundColor='#a17b3e'", onmouseout: "this.style.backgroundColor='var(--tamu-accent)'" %>
      <%= button_to "Delete this expense",
                    expense_path(@expense),
                    method: :delete,
                    data: { turbo_confirm: "Are you sure you want to delete this expense?" },
                    class: "inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out cursor-pointer" %>
    </div>
  </div>
<% end %>

<%# 4. Comments Card %>
<div class="bg-white rounded-lg shadow-md mt-6">
  <div class="p-6">
    <h2 class="text-2xl font-bold mb-4" style="color: var(--tamu-gray-800);">Comments</h2>
    
    <div class="comments-thread space-y-4 divide-y divide-gray-200">
      <% if @expense.comments.any? %>
        <% @expense.comments.order(created_at: :desc).each do |comment| %>
          <div class="comment py-4">
            <strong class="font-medium" style="color: var(--tamu-gray-900);"><%= comment.user.email %></strong>
            <p class="text-gray-700 mt-1"><%= comment.body %></p>
          </div>
        <% end %>
      <% else %>
        <p class="text-gray-500">No comments yet.</p>
      <% end %>
    </div>
  </div>
  
  <%# --- New Comment Form --- %>
  <div class="p-6 border-t border-gray-200" style="background-color: var(--tamu-gray-100);">
    <%= form_with(model: [@expense, Comment.new], local: true, class: "space-y-4") do |f| %>
      <div>
        <%= f.label :body, 'Post a new comment', class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.text_area :body, rows: 3, required: true, class: "form-input mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 sm:text-sm" %>
      </div>
      <div class="actions">
        <%= f.submit 'Post Comment', class: "btn-maroon py-2 px-4 rounded-lg font-semibold cursor-pointer" %>
      </div>
    <% end %>
  </div>
</div>

<%# Determine the correct form object - use simple expense for edit, nested only for new %>
<% if action_name == 'edit' || @group.blank? %>
  <% form_object = @expense %>
<% else %>
  <% form_object = [@group, @expense] %>
<% end %>

<%= form_with model: form_object, local: true do |f| %>
  <% if @expense.errors.any? %>
    <div style="color:red">
      <strong><%= pluralize(@expense.errors.count, "error") %>:</strong>
      <%= @expense.errors.full_messages.to_sentence %>
    </div>
  <% end %>

  <p>
    <%= f.label :title %><br>
    <%= f.text_field :title, required: true %>
  </p>

  <p>
    <%= f.label :amount %><br>
    <%= f.number_field :amount, step: 0.01, min: 0, required: true %>
  </p>

  <p>
    <%= f.label :spent_on, "Spent on" %><br>
    <div style="display: flex; align-items: center; gap: 8px;">
      <%= f.date_field :spent_on, required: true, id: "expense_spent_on" %>
      <button type="button" 
              onclick="document.getElementById('expense_spent_on').value = new Date().toISOString().split('T')[0]"
              style="padding: 4px 8px; background: #500000; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;"
              title="Fill with today's date">
        ðŸ“… Today
      </button>
    </div>
  </p>

  <p>
    <%= f.label :category_id, "Category" %><br>
    <%= f.collection_select :category_id, Category.all, :id, :name, prompt: "Select a category" %>
    <%= link_to "+ Add new category", new_category_path, target: "_blank", style: "margin-left: 10px; color: blue;" %>
  </p>

  <p>
    <%= f.label :notes %><br>
    <%= f.text_area :notes, rows: 3 %>
  </p>

  <% group_for_split = @group || @expense.group %>
  <% if group_for_split.present? %>
    <fieldset style="margin:1rem 0; padding:.75rem; border:1px solid #ccc;">
      <legend>Split Bill</legend>
      <p style="margin-top:0; font-size:0.9rem; color:#555;">Leave blank to split with just you.</p>
      <button type="button"
              style="margin-bottom:0.5rem;"
              onclick="(function(button){ const fieldset = button.closest('fieldset'); if(!fieldset) return; fieldset.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = true); })(this);">
        Split with all
      </button>
      <%= hidden_field_tag 'expense[participant_ids][]', '' %>
      <% group_for_split.users.order(:full_name, :email).each do |member| %>
        <% label_text = member.full_name.presence || member.email %>
        <div style="margin-bottom:0.3rem;">
          <%= check_box_tag 'expense[participant_ids][]', member.id, @expense.participant_ids.include?(member.id), id: "expense_participant_#{member.id}" %>
          <%= label_tag "expense_participant_#{member.id}", label_text %>
        </div>
      <% end %>
    </fieldset>
  <% end %>

  <p><%= f.submit "Save Expense" %></p>
<% end %>
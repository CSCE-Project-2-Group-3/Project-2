<div class="max-w-4xl mx-auto">
  <h1 class="text-3xl font-bold mb-6" style="color: var(--tamu-gray-800);">Your Conversations</h1>

  <%# --- SECTION 1: ACTIVE CONVERSATIONS --- %>
  <h2 class="text-2xl font-semibold mb-4" style="color: var(--tamu-gray-800);">Your Active Conversations</h2>
  <% if @conversations.empty? %>
    <div class="bg-white rounded-lg shadow-md p-6 text-center">
      <p class="text-gray-600">You have no conversations yet.</p>
      <p class="text-sm text-gray-500 mt-2">Click "Send Message" on an expense to start one.</p>
    </div>
  <% else %>
    <div class="bg-white shadow-md rounded-lg overflow-hidden border border-gray-200">
      <ul class="divide-y divide-gray-200">
        <% @conversations.each do |conv| %>
          <% other = conv.other_user(current_user) %>
          <li>
            <%= link_to conversation_path(conv), class: "block p-4 hover:bg-gray-50 transition-colors" do %>
              <strong class="text-lg font-semibold" style="color: var(--tamu-gray-800);"><%= other&.full_name || other&.email || "User ##{other&.id}" %></strong>
              
              <% last = conv.messages.last %>
              <div class="snippet flex justify-between items-center mt-1">
                <% if last %>
                  <em class="text-sm text-gray-600 truncate not-italic">
                    <%# Show "You:" if the last message was from the current user %>
                    <% if last.user == current_user %>
                      <span class="font-medium">You:</span>
                    <% else %>
                      <span class="font-medium"><%= last.user.full_name || last.user.email %>:</span>
                    <% end %>
                    <%= last.body %>
                  </em>
                  <span class="time text-xs text-gray-400 flex-shrink-0 ml-4"><%= time_ago_in_words(last.created_at) %> ago</span>
                <% else %>
                  <em class="text-sm text-gray-500 not-italic">No messages yet</em>
                <% end %>
              </div>
            <% end %>
          </li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%# --- SECTION 2: START A NEW CONVERSATION --- %>
  <h2 class="text-2xl font-semibold mt-12 mb-4" style="color: var(--tamu-gray-800);">Start a Conversation by Group</h2>
  <% if @messageable_by_group.empty? %>
    <div class="bg-white rounded-lg shadow-md p-6 text-center">
      <p class="text-gray-600">You are not in any groups yet.</p>
      <p class="text-sm text-gray-500 mt-2">Join or create a group to start messaging members.</p>
    </div>
  <% else %>
    <%# Loop through each group and create a card for it %>
    <div class="space-y-6">
      <% @messageable_by_group.each do |group, members| %>
        <div class="bg-white shadow-md rounded-lg overflow-hidden border border-gray-200">
          <%# Group Header %>
          <div class="p-4 bg-gray-50 border-b border-gray-200">
            <h3 class="text-lg font-semibold" style="color: var(--tamu-gray-800);"><%= group.name %></h3>
          </div>
          
          <%# List of Members %>
          <% if members.any? %>
            <ul class="divide-y divide-gray-200">
              <% members.each do |member| %>
                <li class="flex justify-between items-center p-4">
                  <span class="font-medium text-gray-700"><%= member.full_name.presence || member.email %></span>
                  <%= button_to "Message", 
                        conversations_path(recipient_id: member.id),
                        method: :post, 
                        class: "btn-maroon py-2 px-4 rounded-lg font-semibold cursor-pointer text-sm" %>
                </li>
              <% end %>
            </ul>
          <% else %>
            <p class="p-4 text-sm text-gray-500">No other members in this group to message.</p>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
